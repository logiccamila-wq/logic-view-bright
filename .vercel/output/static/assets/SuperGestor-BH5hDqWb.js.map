{"version":3,"file":"SuperGestor-BH5hDqWb.js","sources":["../../src/pages/SuperGestor.tsx"],"sourcesContent":["import { Layout } from \"@/components/Layout\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useEffect, useState } from \"react\";\nimport { supabase } from \"@/integrations/supabase/client\";\nimport { predictNextMaintenance, optimizeFuelCosts, predictTireFailureRisk } from \"@/utils/mlPredictive\";\n\ntype Insight = {\n  title: string;\n  value: string | number;\n  detail?: string;\n};\n\nexport default function Supergestor() {\n  const [insights, setInsights] = useState<Insight[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  const fetchInsights = async () => {\n    setLoading(true);\n    setError(\"\");\n    try {\n      const since = new Date();\n      since.setMonth(since.getMonth() - 12);\n\n      const { data: rev } = await supabase\n        .from(\"revenue_records\")\n        .select(\"valor_frete, valor_icms, data_emissao\")\n        .order(\"data_emissao\", { ascending: false })\n        .limit(2000);\n\n      const receitaTotal = (rev || [])\n        .filter(r => new Date(r.data_emissao).getTime() >= since.getTime())\n        .reduce((s, r) => s + (r.valor_frete || 0), 0);\n\n      const icmsTotal = (rev || [])\n        .filter(r => new Date(r.data_emissao).getTime() >= since.getTime())\n        .reduce((s, r) => s + (r.valor_icms || 0), 0);\n\n      const { data: vehicles } = await supabase\n        .from(\"vehicles\")\n        .select(\"id, status\");\n      const vehiclesActive = (vehicles || []).filter(v => String(v.status || '').toUpperCase().includes(\"ATIV\")).length || (vehicles || []).length;\n\n      const { data: orders } = await supabase\n        .from(\"service_orders\")\n        .select(\"status, vehicle_plate, odometer, created_at, completed_at, labor_hours\");\n      const ordersPending = (orders || []).filter(o => (o.status || '').toLowerCase().includes(\"abert\") || (o.status || '').toLowerCase().includes(\"pend\")).length;\n\n      const { data: ncs, error: ncErr } = await (supabase as any)\n        .from(\"non_conformities\")\n        .select(\"severity, status\")\n        .limit(500);\n      const criticalNC = ncErr ? 0 : (ncs || []).filter((n: any) => (n.status || '').toLowerCase().includes(\"open\") || (n.severity || 0) >= 7).length;\n\n      const { data: trips } = await (supabase as any)\n        .from(\"trips\")\n        .select(\"status\")\n        .limit(500);\n      const tripsRunning = (trips || []).filter((t: any) => (t.status || '').toLowerCase().includes(\"andamento\") || (t.status || '').toLowerCase().includes(\"ativa\")).length;\n\n      const { data: refuelings } = await supabase\n        .from(\"refuelings\")\n        .select(\"cost_per_km, timestamp, vehicle_plate\")\n        .order(\"timestamp\", { ascending: false })\n        .limit(2000);\n      const fuel = optimizeFuelCosts((refuelings || []).map(r => ({\n        km: 0,\n        liters: 0,\n        total_value: 0,\n        cost_per_km: r.cost_per_km,\n        timestamp: r.timestamp,\n        vehicle_plate: r.vehicle_plate,\n      })));\n      const avgCostKm = fuel.avgCostPerKm;\n\n      const byPlate = new Map<string, any[]>();\n      (orders || []).forEach(o => {\n        if (!byPlate.has(o.vehicle_plate)) byPlate.set(o.vehicle_plate, []);\n        byPlate.get(o.vehicle_plate)!.push(o);\n      });\n      let predictedMaint = 0;\n      byPlate.forEach((list, plate) => {\n        const currentOdo = Math.max(...list.map(l => l.odometer || 0));\n        const pred = predictNextMaintenance(list.map(l => ({\n          status: l.status,\n          created_at: l.created_at || new Date().toISOString(),\n          completed_at: l.completed_at,\n          vehicle_plate: plate,\n          odometer: l.odometer || 0,\n          labor_hours: l.labor_hours || 0,\n        })), currentOdo);\n        if (pred.predictedDays <= 30) predictedMaint += 1;\n      });\n\n      const { data: tpms } = await supabase\n        .from(\"tpms_readings\")\n        .select(\"pressure_psi, temperature_celsius, tread_depth_mm, alert_level, created_at, vehicle_plate, tire_position\")\n        .order(\"created_at\", { ascending: false })\n        .limit(200);\n      const tire = (tpms && tpms.length > 0) ? predictTireFailureRisk(tpms) : null;\n\n      const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });\n      const list: Insight[] = [\n        { title: \"Receita Total (12m)\", value: fmt.format(receitaTotal || 0) },\n        { title: \"ICMS Total (12m)\", value: fmt.format(icmsTotal || 0) },\n        { title: \"Veículos Ativos\", value: vehiclesActive || 0 },\n        { title: \"Ordens Pendentes\", value: ordersPending || 0 },\n        { title: \"NCs Críticas\", value: criticalNC || 0 },\n        { title: \"Rotas em Andamento\", value: tripsRunning || 0 },\n        { title: \"Custo/KM Médio\", value: avgCostKm || \"--\" },\n        { title: \"Previsões Manutenção (30d)\", value: predictedMaint || 0, detail: tire ? `Risco pneus: ${tire.riskScore}%` : undefined },\n      ];\n      setInsights(list);\n    } catch (e: unknown) {\n      const message = e instanceof Error ? e.message : String(e);\n      setError(message || \"Falha ao carregar insights\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => { fetchInsights(); }, []);\n\n  return (\n    <Layout>\n      <div className=\"space-y-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Supergestor</h1>\n          <p className=\"text-muted-foreground\">IA integrada para decisões operacionais e financeiras</p>\n        </div>\n\n        {error && (\n          <Card className=\"border-destructive\">\n            <CardContent className=\"p-4 text-destructive\">{error}</CardContent>\n          </Card>\n        )}\n\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          {insights.map((i, idx) => (\n            <Card key={idx}>\n              <CardHeader>\n                <CardTitle>{i.title}</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">{i.value}</div>\n                {i.detail && <p className=\"text-sm text-muted-foreground mt-1\">{i.detail}</p>}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n\n        <div className=\"flex gap-2\">\n          <Button onClick={fetchInsights} disabled={loading}>Atualizar Insights</Button>\n          <Button variant=\"outline\" onClick={async () => {\n            try {\n              const r = await fetch(\"/api/predict-maintenance\");\n              const js = await r.json();\n              alert(`Previstos: ${js.predictions?.length || 0}`);\n            } catch (err) {\n              const msg = err instanceof Error ? err.message : String(err);\n              alert(`Falha ao rodar preditivo: ${msg}`);\n            }\n          }}>Rodar Preditivo</Button>\n        </div>\n      </div>\n    </Layout>\n  );\n}\n"],"names":["Supergestor","insights","setInsights","useState","loading","setLoading","error","setError","fetchInsights","since","Date","setMonth","getMonth","data","rev","supabase","from","select","order","ascending","limit","receitaTotal","filter","r","data_emissao","getTime","reduce","s","valor_frete","icmsTotal","valor_icms","vehicles","vehiclesActive","v","String","status","toUpperCase","includes","length","orders","ordersPending","o","toLowerCase","ncs","ncErr","criticalNC","n","severity","trips","tripsRunning","t","refuelings","avgCostKm","optimizeFuelCosts","map","km","liters","total_value","cost_per_km","timestamp","vehicle_plate","avgCostPerKm","byPlate","Map","forEach","has","set","get","push","predictedMaint","list","plate","currentOdo","Math","max","l","odometer","predictNextMaintenance","created_at","toISOString","completed_at","labor_hours","predictedDays","tpms","tire","predictTireFailureRisk","fmt","Intl","NumberFormat","style","currency","title","value","format","detail","riskScore","undefined","e","message","Error","useEffect","Layout","jsxs","jsx","Card","CardContent","i","idx","CardHeader","CardTitle","Button","js","fetch","json","alert","predictions","err","msg"],"mappings":"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"}